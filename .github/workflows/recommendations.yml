name: Generate Market Recommendations

on:
  schedule:
    # ğŸ• 4 Ñ€Ğ°Ğ·Ğ¸ Ğ½Ğ° Ğ´ĞµĞ½ÑŒ Ğ² ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ
    - cron: '0 8 * * *'   # 08:00 ĞšĞ¸Ñ—Ğ² (06:00 UTC)
    - cron: '0 12 * * *'  # 12:00 ĞšĞ¸Ñ—Ğ² (10:00 UTC)
    - cron: '0 16 * * *'  # 16:00 ĞšĞ¸Ñ—Ğ² (14:00 UTC)
    - cron: '0 20 * * *'  # 20:00 ĞšĞ¸Ñ—Ğ² (18:00 UTC)
  
  workflow_dispatch:
    inputs:
      language:
        description: 'ĞœĞ¾Ğ²Ğ° Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ğ¹'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      force_analysis:
        description: 'ĞŸÑ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ñ–Ğ· (Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞºĞµÑˆ)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-recommendations:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: generate-recommendations-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Clear caches
      run: |
        echo "ğŸ§¹ ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ ĞºĞµÑˆÑƒ..."
        pip cache purge || echo "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ pip cache"
        rm -rf ~/.cache/pip 2>/dev/null || true
        echo "âœ… ĞšĞµÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        if [ -f backend/requirements.txt ]; then
          pip install --no-cache-dir -r backend/requirements.txt
          echo "âœ… Ğ—Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾"
        else
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» requirements.txt Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!"
          exit 1
        fi
    
    - name: Create necessary directories
      run: |
        echo "ğŸ“ Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ğ¹..."
        mkdir -p data logs
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ„Ğ°Ğ¹Ğ»Ğ¸, ÑĞºÑ‰Ğ¾ Ñ—Ñ… Ğ½ĞµĞ¼Ğ°Ñ”
        if [ ! -f data/recommendations.json ]; then 
          echo '{"last_update": null, "recommendations": [], "market_overview": {}, "timezone": "Europe/Kiev"}' > data/recommendations.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ recommendations.json"
        fi
        
        if [ ! -f data/history_recommendations.json ]; then 
          echo '[]' > data/history_recommendations.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ history_recommendations.json"
        fi
        
        if [ ! -f data/news_cache.json ]; then 
          echo '{"last_update": null, "news": []}' > data/news_cache.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ news_cache.json"
        fi
        
        if [ ! -f data/economic_indicators.json ]; then 
          echo '{"last_update": null, "indicators": {}}' > data/economic_indicators.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ economic_indicators.json"
        fi
        
        touch .nojekyll
    
    - name: Generate market recommendations
      env:
        TZ: 'Europe/Kiev'
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        LANGUAGE: ${{ inputs.language || 'uk' }}
        FORCE_ANALYSIS: ${{ inputs.force_analysis || 'false' }}
        GROQ_MODEL: 'openai/gpt-oss-120b'
        CACHE_HOURS: '6'
        LOG_LEVEL: 'INFO'
        MAX_RECOMMENDATIONS: '8'
      run: |
        echo "ğŸš€ ĞŸĞĞ§ĞĞ¢ĞĞš Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ†Ğ‡ Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ¦Ğ†Ğ™"
        echo "========================================"
        echo "â° Ğ—Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ğŸ  ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ: $(TZ='Europe/Kiev' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ ĞœĞ¾Ğ²Ğ°: $LANGUAGE"
        echo "ğŸ§  AI: $GROQ_MODEL"
        echo "ğŸ“Š ĞœĞ°ĞºÑ. Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ğ¹: $MAX_RECOMMENDATIONS"
        echo "ğŸ’¾ ĞšĞµÑˆ: $CACHE_HOURS Ğ³Ğ¾Ğ´Ğ¸Ğ½"
        echo "========================================"
        
        export PYTHONPATH=$PYTHONPATH:$(pwd)/backend:$(pwd):$(pwd)/utils
        
        cd backend
        echo "â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº currency_advisor.py..."
        python currency_advisor.py
        
        echo "âœ… Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ¾ $(date '+%H:%M:%S') UTC"
    
    - name: Verify recommendations were created
      run: |
        echo "ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ–Ğ²..."
        if [ -f data/recommendations.json ]; then
          REC_COUNT=$(jq '.recommendations | length' data/recommendations.json 2>/dev/null || echo "0")
          echo "ğŸ“Š Ğ—Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ğ¹: $REC_COUNT"
          
          if [ "$REC_COUNT" -gt 0 ]; then
            echo "ğŸ¯ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ñ— ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾ Ğ·Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ñ–!"
            
            # Ğ’Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿ĞµÑ€ÑˆÑ– 3 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ñ— Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸
            echo "ğŸ“‹ Ğ¢Ğ¾Ğ¿-3 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ñ—:"
            jq -r '.recommendations[0:3] | .[] | "  â€¢ \(.asset): \(.action) (\(.confidence*100|floor)%)\n    ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: \(.reason[0:50])..."' data/recommendations.json 2>/dev/null || echo "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚Ğ¸"
          else
            echo "âš ï¸  Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ğ¹ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
          fi
        else
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» recommendations.json Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾!"
          exit 1
        fi
    
    - name: Update frontend files
      run: |
        echo "ğŸ”„ ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ frontend Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²..."
        
        # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾, Ñ‡Ğ¸ Ñ” Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        if [ -f data/recommendations.json ]; then
          LAST_UPDATE=$(jq -r '.last_update' data/recommendations.json)
          echo "ğŸ• ĞÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ: $LAST_UPDATE"
        fi
    
    - name: Commit and push changes
      if: success()
      run: |
        echo "ğŸ’¾ ĞŸÑ–Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ¾ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ..."
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ² Ğ´Ğ°Ğ½Ğ¸Ñ…
        git add data/
        git add .nojekyll
        
        if git diff --staged --quiet; then
          echo "âš ï¸ ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ¼Ñ–Ğ½ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ"
        else
          CURRENT_TIME=$(TZ='Europe/Kiev' date '+%H:%M')
          git commit -m "ğŸ¤– Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ñ—: $(date +'%Y-%m-%d %H:%M') [ĞœĞ¾Ğ²Ğ°: ${{ inputs.language || 'uk' }}]"
          git push origin main
          echo "âœ… Ğ—Ğ¼Ñ–Ğ½Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ¼Ñ–Ñ‡ĞµĞ½Ğ¾ Ñ‚Ğ° Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾"
          echo "ğŸ• Ğ§Ğ°Ñ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ (ĞšĞ¸Ñ—Ğ²): $CURRENT_TIME"
        fi
    
    - name: Log completion time
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ Ğ¾ $(date '+%H:%M:%S') UTC"
        echo "ğŸ  ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ: $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        echo "â³ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ñ–Ğ·:"
        echo "   â€¢ 08:00 (Ñ€Ğ°Ğ½Ğ¾Ğº)"
        echo "   â€¢ 12:00 (Ğ¾Ğ±Ñ–Ğ´)"
        echo "   â€¢ 16:00 (Ğ²ĞµÑ‡Ñ–Ñ€)"
        echo "   â€¢ 20:00 (Ğ½Ñ–Ñ‡)"
        echo "ğŸ“Š ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Actions -> recommendations.yml"
        echo "ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: https://danik25326.github.io/pocket_trading_bot/"
        echo "========================================"
