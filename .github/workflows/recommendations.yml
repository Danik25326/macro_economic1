name: Generate Market Recommendations

on:
  schedule:
    # üïê 4 —Ä–∞–∑–∏ –Ω–∞ –¥–µ–Ω—å –≤ –ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å
    - cron: '0 8 * * *'   # 08:00 –ö–∏—ó–≤ (06:00 UTC)
    - cron: '0 12 * * *'  # 12:00 –ö–∏—ó–≤ (10:00 UTC)
    - cron: '0 16 * * *'  # 16:00 –ö–∏—ó–≤ (14:00 UTC)
    - cron: '0 20 * * *'  # 20:00 –ö–∏—ó–≤ (18:00 UTC)
  
  workflow_dispatch:
    inputs:
      language:
        description: '–ú–æ–≤–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      force_analysis:
        description: '–ü—Ä–∏–º—É—Å–æ–≤–∏–π –∞–Ω–∞–ª—ñ–∑ (—ñ–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –∫–µ—à)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-recommendations:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: generate-recommendations-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Clear caches
      run: |
        echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É..."
        pip cache purge || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—á–∏—Å—Ç–∏—Ç–∏ pip cache"
        rm -rf ~/.cache/pip 2>/dev/null || true
        echo "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω–æ"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        
        echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
        pip install --no-cache-dir groq==0.9.0
        pip install --no-cache-dir python-dotenv==1.0.0
        pip install --no-cache-dir pytz==2023.3
        pip install --no-cache-dir feedparser==6.0.10
        pip install --no-cache-dir aiohttp==3.9.1
        pip install --no-cache-dir beautifulsoup4==4.12.2
        pip install --no-cache-dir lxml==5.1.0
        pip install --no-cache-dir pandas==2.1.4
        pip install --no-cache-dir numpy==1.26.2
        pip install --no-cache-dir python-dateutil==2.8.2
        pip install --no-cache-dir colorlog==6.8.0
        pip install --no-cache-dir requests==2.31.0
        pip install --no-cache-dir ujson==5.8.0
        
        echo "‚úÖ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    
    - name: Create necessary directories
      run: |
        echo "üìÅ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π..."
        mkdir -p data logs backend/utils
        
        # –ö–æ–ø—ñ—é—î–º–æ —Ñ–∞–π–ª–∏ –ª–æ–≥–µ—Ä–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –º—ñ—Å—Ü–µ
        echo "üìÇ –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ utils..."
        if [ -d utils ]; then
          cp -r utils/* backend/utils/ 2>/dev/null || true
        fi
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
        if [ ! -f data/recommendations.json ]; then 
          echo '{"last_update": null, "recommendations": [], "market_overview": {}, "timezone": "Europe/Kiev"}' > data/recommendations.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ recommendations.json"
        fi
        
        if [ ! -f data/history_recommendations.json ]; then 
          echo '[]' > data/history_recommendations.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ history_recommendations.json"
        fi
        
        if [ ! -f data/news_cache.json ]; then 
          echo '{"last_update": null, "news": []}' > data/news_cache.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ news_cache.json"
        fi
        
        if [ ! -f data/economic_indicators.json ]; then 
          echo '{"last_update": null, "indicators": {}}' > data/economic_indicators.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ economic_indicators.json"
        fi
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ñ–∞–π–ª–∏ __init__.py –¥–ª—è –ø–∞–∫–µ—Ç—ñ–≤
        touch backend/__init__.py
        touch backend/utils/__init__.py
        
        touch .nojekyll
        
        echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π:"
        find . -type f -name "*.py" | head -20
    
    - name: Verify Python environment
      run: |
        echo "üêç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ Python..."
        python --version
        echo "üìÅ –ü–æ—Ç–æ—á–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥:"
        pwd
        echo "üìÅ –í–º—ñ—Å—Ç –∫–∞—Ç–∞–ª–æ–≥—É:"
        ls -la
        echo "üìÅ –í–º—ñ—Å—Ç backend/:"
        ls -la backend/
        echo "üìÅ –í–º—ñ—Å—Ç utils/:"
        ls -la utils/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó utils –Ω–µ —ñ—Å–Ω—É—î"
    
    - name: Test imports
      run: |
        echo "üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—ñ–≤ Python..."
        cd backend
        python -c "
import sys
print('Python path:', sys.path)

# –¢–µ—Å—Ç—É—î–º–æ –±–∞–∑–æ–≤—ñ —ñ–º–ø–æ—Ä—Ç–∏
try:
    import logging
    print('‚úÖ logging: OK')
except Exception as e:
    print(f'‚ùå logging: {e}')

try:
    from config import Config
    print('‚úÖ config: OK')
except Exception as e:
    print(f'‚ùå config: {e}')

try:
    from news_analyzer import NewsAnalyzer
    print('‚úÖ news_analyzer: OK')
except Exception as e:
    print(f'‚ùå news_analyzer: {e}')

try:
    from economic_data import EconomicDataCollector
    print('‚úÖ economic_data: OK')
except Exception as e:
    print(f'‚ùå economic_data: {e}')

try:
    from groq_analyzer import GroqAnalyzer
    print('‚úÖ groq_analyzer: OK')
except Exception as e:
    print(f'‚ùå groq_analyzer: {e}')

try:
    from data_handler import DataHandler
    print('‚úÖ data_handler: OK')
except Exception as e:
    print(f'‚ùå data_handler: {e}')
"
    
    - name: Generate market recommendations
      env:
        TZ: 'Europe/Kiev'
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        LANGUAGE: ${{ inputs.language || 'uk' }}
        FORCE_ANALYSIS: ${{ inputs.force_analysis || 'false' }}
        GROQ_MODEL: 'openai/gpt-oss-120b'
        CACHE_HOURS: '6'
        LOG_LEVEL: 'INFO'
        MAX_RECOMMENDATIONS: '8'
        MIN_CONFIDENCE: '0.65'
        PYTHONPATH: '${{ github.workspace }}/backend:${{ github.workspace }}:${{ github.workspace }}/utils'
      run: |
        echo "üöÄ –ü–û–ß–ê–¢–û–ö –ì–ï–ù–ï–†–ê–¶–Ü–á –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–ô"
        echo "========================================"
        echo "‚è∞ –ó–∞–ø—É—â–µ–Ω–æ: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "üè† –ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å: $(TZ='Europe/Kiev' date '+%Y-%m-%d %H:%M:%S')"
        echo "üåê –ú–æ–≤–∞: $LANGUAGE"
        echo "üß† AI: $GROQ_MODEL"
        echo "üìä –ú–∞–∫—Å. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π: $MAX_RECOMMENDATIONS"
        echo "üíæ –ö–µ—à: $CACHE_HOURS –≥–æ–¥–∏–Ω"
        echo "üìà –ú—ñ–Ω. –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å: $MIN_CONFIDENCE"
        echo "========================================"
        
        echo "üìÅ –ü–æ—Ç–æ—á–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥: $(pwd)"
        echo "üìÅ –í–º—ñ—Å—Ç –∫–∞—Ç–∞–ª–æ–≥—É:"
        ls -la
        
        echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è PYTHONPATH..."
        export PYTHONPATH="$PYTHONPATH:${{ github.workspace }}/backend:${{ github.workspace }}:${{ github.workspace }}/utils"
        echo "PYTHONPATH: $PYTHONPATH"
        
        cd backend
        echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ currency_advisor.py..."
        
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
        python currency_advisor.py
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
        EXIT_CODE=$?
        if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ –°–∫—Ä–∏–ø—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è"
        else
            echo "‚ùå –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –∫–æ–¥–æ–º –ø–æ–º–∏–ª–∫–∏: $EXIT_CODE"
            exit $EXIT_CODE
        fi
        
        echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –æ $(date '+%H:%M:%S') UTC"
    
    - name: Verify recommendations were created
      run: |
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤..."
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î —Ñ–∞–π–ª
        if [ -f data/recommendations.json ]; then
            echo "üìÑ –§–∞–π–ª recommendations.json —ñ—Å–Ω—É—î"
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ñ–∞–π–ª –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π
            FILE_SIZE=$(stat -f%z data/recommendations.json 2>/dev/null || stat -c%s data/recommendations.json 2>/dev/null || echo "0")
            
            if [ "$FILE_SIZE" -gt 50 ]; then
                echo "üìä –§–∞–π–ª –º–∞—î —Ä–æ–∑–º—ñ—Ä: $FILE_SIZE –±–∞–π—Ç"
                
                # –°–ø—Ä–æ–±—É—î–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ jq –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É
                if command -v jq &> /dev/null; then
                    REC_COUNT=$(jq '.recommendations | length' data/recommendations.json 2>/dev/null || echo "0")
                    echo "üìà –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π: $REC_COUNT"
                    
                    if [ "$REC_COUNT" -gt 0 ]; then
                        echo "üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ!"
                        
                        # –í–∏–≤–æ–¥–∏–º–æ –ø–µ—Ä—à—ñ 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                        echo "üìã –¢–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:"
                        jq -r '.recommendations[0:3] | .[] | "  ‚Ä¢ \(.asset): \(.action) (\(.confidence*100|floor)%)\n    –ü—Ä–∏—á–∏–Ω–∞: \(.reason[0:50])..."' data/recommendations.json 2>/dev/null || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ"
                    else
                        echo "‚ö†Ô∏è  –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
                        # –ü–æ–∫–∞–∑—É—î–º–æ –≤–º—ñ—Å—Ç —Ñ–∞–π–ª—É –¥–ª—è –¥–µ–±–∞–≥—É
                        echo "üìÑ –í–º—ñ—Å—Ç —Ñ–∞–π–ª—É (–ø–µ—Ä—à—ñ 500 —Å–∏–º–≤–æ–ª—ñ–≤):"
                        head -c 500 data/recommendations.json
                        echo ""
                    fi
                else
                    echo "üìÑ –í–º—ñ—Å—Ç —Ñ–∞–π–ª—É (–ø–µ—Ä—à—ñ 1000 —Å–∏–º–≤–æ–ª—ñ–≤):"
                    head -c 1000 data/recommendations.json
                    echo ""
                fi
            else
                echo "‚ö†Ô∏è  –§–∞–π–ª recommendations.json –ø–æ—Ä–æ–∂–Ω—ñ–π –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –º–∞–ª–∏–π"
                echo "üìÑ –í–º—ñ—Å—Ç —Ñ–∞–π–ª—É:"
                cat data/recommendations.json
            fi
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            if command -v jq &> /dev/null; then
                LAST_UPDATE=$(jq -r '.last_update' data/recommendations.json 2>/dev/null || echo "null")
                echo "üïê –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: $LAST_UPDATE"
            fi
            
        else
            echo "‚ùå –§–∞–π–ª recommendations.json –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ!"
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —ñ–Ω—à—ñ —Ñ–∞–π–ª–∏ –¥–∞–Ω–∏—Ö
            echo "üîé –ü–æ—à—É–∫ —ñ–Ω—à–∏—Ö —Ñ–∞–π–ª—ñ–≤ –¥–∞–Ω–∏—Ö..."
            ls -la data/ || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è data –Ω–µ —ñ—Å–Ω—É—î"
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–≥–∏
            echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤..."
            if [ -d logs ]; then
                echo "–õ–æ–≥–∏ –∑–Ω–∞–π–¥–µ–Ω–æ:"
                ls -la logs/
                if [ -f logs/*.log ]; then
                    echo "–û—Å—Ç–∞–Ω–Ω—ñ 20 —Ä—è–¥–∫—ñ–≤ –ª–æ–≥—É:"
                    tail -20 logs/*.log 2>/dev/null || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –ª–æ–≥–∏"
                fi
            fi
            
            exit 1
        fi
    
    - name: Update frontend files
      run: |
        echo "üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è frontend —Ñ–∞–π–ª—ñ–≤..."
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç–∏–π HTML —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        if [ -f data/recommendations.json ]; then
            HTML_FILE="index_test.html"
            echo "<html><head><title>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</title></head><body>" > $HTML_FILE
            echo "<h1>–û—Å—Ç–∞–Ω–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h1>" >> $HTML_FILE
            echo "<p>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: $(date)</p>" >> $HTML_FILE
            
            if command -v jq &> /dev/null; then
                REC_COUNT=$(jq '.recommendations | length' data/recommendations.json 2>/dev/null || echo "0")
                echo "<p>–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π: $REC_COUNT</p>" >> $HTML_FILE
                
                if [ "$REC_COUNT" -gt 0 ]; then
                    echo "<ul>" >> $HTML_FILE
                    jq -r '.recommendations[0:5] | .[] | "<li>\(.asset): \(.action) (\(.confidence*100|floor)%) - \(.reason[0:100])...</li>"' data/recommendations.json >> $HTML_FILE 2>/dev/null || echo "<li>–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</li>" >> $HTML_FILE
                    echo "</ul>" >> $HTML_FILE
                fi
            fi
            
            echo "</body></html>" >> $HTML_FILE
            echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–∏–π HTML —Ñ–∞–π–ª"
        fi
    
    - name: Commit and push changes
      if: success()
      run: |
        echo "üíæ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –∫–æ–º—ñ—Ç—É..."
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # –î–æ–¥–∞—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–∏ –≤ –¥–∞–Ω–∏—Ö
        git add data/
        git add .nojekyll
        
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
        else
          CURRENT_TIME=$(TZ='Europe/Kiev' date '+%H:%M')
          git commit -m "ü§ñ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó: $(date +'%Y-%m-%d %H:%M') [–ú–æ–≤–∞: ${{ inputs.language || 'uk' }}]"
          git push origin main
          echo "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"
          echo "üïê –ß–∞—Å –∫–æ–º—ñ—Ç—É (–ö–∏—ó–≤): $CURRENT_TIME"
        fi
    
    - name: Log completion time
      if: always()
      run: |
        echo "========================================"
        echo "üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –æ $(date '+%H:%M:%S') UTC"
        echo "üè† –ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å: $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        echo "‚è≥ –ù–∞—Å—Ç—É–ø–Ω–∏–π –∞–Ω–∞–ª—ñ–∑:"
        echo "   ‚Ä¢ 08:00 (—Ä–∞–Ω–æ–∫)"
        echo "   ‚Ä¢ 12:00 (–æ–±—ñ–¥)"
        echo "   ‚Ä¢ 16:00 (–≤–µ—á—ñ—Ä)"
        echo "   ‚Ä¢ 20:00 (–Ω—ñ—á)"
        echo "üìä –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: Actions -> recommendations.yml"
        echo "üåê –°–∞–π—Ç: https://danik25326.github.io/pocket_trading_bot/"
        echo "========================================"
